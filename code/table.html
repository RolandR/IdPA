<html>
  <head>
    <title>Table</title>
    <style>
      *
      {
        margin:0px;
	padding:0px;
	border:0px;
      }
      table
      {
      }
      td
      {
        border:1px #000000 solid;
	padding:2px;
	border-top:0px;
	border-left:0px;
	width:18px;
	text-align:center;
      }
      tr
      {
	height:18px;
      }
    </style>
    <script>
      window.onload=function()
      {
        console.log("window ready")
	var squarestr = "";
	for( var i=0; i<26; i++)
	{
	  squarestr=squarestr+"<tr>";
	  for( var u=0; u<26; u++)
	  {
	    var character = 65+((u+i)%26);
	    squarestr=squarestr+"<td>"+String.fromCharCode(character)+"</td>";
	  }
	  squarestr=squarestr+"</tr>";
	}
	document.getElementById("vsquare").innerHTML = squarestr;
      }

      /**
       * Create an array of numbers from the password string
       * Returns an array of numbers
       * All chars will assumed to be uppercaase
       * Everything but characters will be ignored!
       */
      function preparePassword(password)
      {
	var numbered = new Array();
	// We need to count manually, as we ignore things other than text characters
	l = 0;
        for (m=0; m<password.length; m++)
	{
	  var asciiValue = password.charCodeAt(m);

	  if(asciiValue > 96 && asciiValue < 123)
	  {
	    numbered[l] = (asciiValue-97);
	    l++;
	    continue;
	  }
	  if(asciiValue > 64 && asciiValue < 91)
	  {
	    numbered[l] = (asciiValue-65);
	    l++;
	    continue;
	  }
	}
	return numbered;
      }

      /**
       * Encrypt a text.
       * @pwArray - Array of numbers that is the key.
       *            You can retrieve such an array from
       *	    the preparePassword function
       *
       * @text - Text to be encrypted
       * 
       * returns a string with the encrypted text
       */
      function encryptText(pwArray, text)
      {
        console.log("encryptText started");
	// We can't use the loop variable to read out a number from
	// the pwArray. That's because it gets counted up on non characters
	// (such as spaces) too. But we want these types of chars to be 
	// completely unaffected! So we have our own variable that gets only
	// incremented when there's an actual character to be encoded
	l = 0;
        var encText = "";

	for (n=0; n<text.length; n++)
	{
	  var asciiValue = text.charCodeAt(n); 
	  if(asciiValue > 96 && asciiValue < 123)
	  {
	    console.log("lower case");
	    var calcValue = asciiValue-97;
	    var foo = ((calcValue+pwArray[l%(pwArray.length)])%26)
	    // Add 65 to make it an uppercase character
	    encText += String.fromCharCode(foo+65);
	    l++;
	    continue;
	  }
	  if(asciiValue > 64 && asciiValue < 91)
	  {
	    console.log("upper case")
	    var calcValue = asciiValue-65;
	    var foo = ((calcValue+pwArray[l%(pwArray.length)])%26)
	    encText += String.fromCharCode(foo+65);
	    l++;
	    continue;
	  }

	  encText += String.fromCharCode(asciiValue);
	  console.log("not a character");
	}

	console.log("encryptText is about to end");
	return encText;
      }

      function decryptText(pwArray, text)
      {
        l=0;
	var decText = "";

	for(n=0; n<text.length; n++)
	{
	  var asciiValue = text.charCodeAt(n);
	  if(asciiValue > 96 && asciiValue < 123)
	  {
	    console.log("loewr case. What's that doing in there??");
	    var calcValue = asciiValue-97;
	    var foo = ((26+calcValue-pwArray[l%(pwArray.length)])%26)
	    decText += String.fromCharCode(foo+65);
	    l++;
	    continue;
	  }

	  if(asciiValue > 64 && asciiValue < 91)
	  {
	    console.log("upper case")
	    var calcValue = asciiValue-65;
	    var foo = ((26+calcValue-pwArray[l%(pwArray.length)])%26)
	    decText += String.fromCharCode(foo+65);
	    l++;
	    continue;
	  }

	  decText += String.fromCharCode(asciiValue);
	  console.log("not a character");
	}
	return decText;
      }

    </script>
  </head>
  <body onReady="genSquare">
    <table id="vsquare" cellspacing=0 cellpadding=0>
    </table>
    <script>
      // define a password
      password = "Hello World";
      // Then transform it into an array of numbers
      // everything will be uppercased. Everything that's not a character
      // will be ignored!
      var pwArray = preparePassword(password);

      // Now encrypt the text. Everything will be uppercased.
      // Everything that is not a character will be put back in the same
      // place unchanged
      var encText = encryptText(pwArray, "Mein Hut der hat 3 Ecken, 3 Ecken hat mein Hut. Und haett er nicht 3 Ecken, so waer es nicht mein Hut. Ich brauche aber, damit die Analyse moeglich wird, einen deutlich laengeren Text. Deshalb schreib ich hier jetzt eine Menge 'Seich' rein. Ich hoffe das genuegt allmaehlich, denn ich mag mir nicht noch mehr mist ausdenken.");

      document.write("<br />");

      // Write out the encrypted text
      for(var a=0; a < encText.length; a++)
      {
        document.write(encText[a]);
      }

      var decText = decryptText(pwArray, encText);

      document.write("<br />");

      // Write out the encrypted text
      for(var a=0; a < decText.length; a++)
      {
        document.write(decText[a]);
      }

    </script>
  </body>
</html>
